rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------
    // Helpers
    // -------------------------
    function signedIn() {
      return request.auth != null;
    }

    // Check if the user has role 'admin'
    // This is the OFFICIAL admin authentication rule for the system
    function isAdmin() {
      return signedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return signedIn() && request.auth.uid == userId;
    }

    // -------------------------
    // USERS COLLECTION
    // users/{userId}
    // -------------------------
    match /users/{userId} {

      // User can read their own data or admin can read
      allow read: if isOwner(userId) || isAdmin();

      // User can create their profile document (during onboarding)
      // but cannot set role or modify it
      allow create: if isOwner(userId)
        && (!('uid' in request.resource.data) 
            || request.resource.data.uid == userId)
        && !('role' in request.resource.data)
        && !('roles' in request.resource.data)
        && !('admin' in request.resource.data);

      // Update allowed only to the owner AND not touching role fields
      allow update: if isOwner(userId)
        && !('role' in request.resource.data)
        && !('roles' in request.resource.data)
        && !('admin' in request.resource.data);

      // Deleting allowed for owner or admin
      allow delete: if isOwner(userId) || isAdmin();

      // Subcollections of users (profiles, diaryEntries, etc.)
      // Admins can read for statistics, owners can read and write
      match /{subPath=**} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }

    // -------------------------
    // FOODS COLLECTION
    // foods/{foodId}
    // -------------------------
    match /foods/{foodId} {
      allow read: if true;                 // Everyone can read foods
      allow create, update, delete: if isAdmin();   // Only admin can write
    }

    // -------------------------
    // EXERCISES COLLECTION
    // exercises/{exerciseId}
    // -------------------------
    match /exercises/{exerciseId} {

      // Admins can read ALL exercises (even disabled)
      // Regular users only see exercises with isEnabled == true
      allow read: if isAdmin() || (signedIn() && resource.data.isEnabled == true);

      // Only admin can manage exercises
      allow create, update, delete: if isAdmin();
    }

    // -------------------------
    // RECIPES COLLECTION
    // recipes/{recipeId}
    // -------------------------
    match /recipes/{recipeId} {
      // User creates recipe for approval
      allow create: if signedIn()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.isApproved == false;

      // User can edit their own recipe (not approved)
      // Admin can edit anything
      allow update: if isAdmin()
        || (signedIn()
            && resource.data.authorId == request.auth.uid
            && request.resource.data.authorId == resource.data.authorId
            && request.resource.data.isApproved == resource.data.isApproved);

      allow delete: if isAdmin()
        || (signedIn() && resource.data.authorId == request.auth.uid);

      // Reading rules:
      // - Anyone can read an approved recipe
      // - Author can read their own draft
      // - Admin can read everything
      allow read: if resource.data.isApproved == true
        || (signedIn() && resource.data.authorId == request.auth.uid)
        || isAdmin();
    }

    // -------------------------
    // DIARY ENTRIES
    // diaries/{userId}/entries/{entryId}
    // -------------------------
    match /diaries/{userId}/entries/{entryId} {

      // Create only for the correct owner
      allow create: if isOwner(userId)
        && (!('userId' in request.resource.data)
            || request.resource.data.userId == userId);

      // Owner can read, update, delete
      // Admin can read for statistics
      allow read: if isOwner(userId) || isAdmin();
      allow update, delete: if isOwner(userId) || isAdmin();
    }

    // -------------------------
    // NOTIFICATIONS
    // notifications/{userId}/messages/{msgId}
    // -------------------------
    match /notifications/{userId}/messages/{msgId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    // -------------------------
    // AUDIT LOGS
    // auditLogs/{logId}
    // -------------------------
    match /auditLogs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      // System/admins can create logs (no manual updates or deletes)
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // -------------------------
    // DENY EVERYTHING ELSE
    // -------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
